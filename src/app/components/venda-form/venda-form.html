<h2>{{ isEdit ? 'Editar' : 'Nova' }} Venda</h2>

<form [formGroup]="form" (ngSubmit)="onSubmit()">
  <div>
    <label for="clienteId">Cliente: <span class="required">*</span></label>
    <select id="clienteId" formControlName="clienteId" required>
      <option [ngValue]="null" disabled>Selecione um cliente</option>
      <option *ngFor="let c of clientes" [value]="c.codcliente">{{ c.nomecliente }}</option>
    </select>
    <div class="error-message" *ngIf="form.get('clienteId')?.hasError('required') && form.get('clienteId')?.touched">
      Cliente é obrigatório
    </div>
  </div>

  <hr style="margin: 32px 0; border: none; border-top: 1px solid #e2e8f0;">

  <h3>Adicionar Produto</h3>
  <div [formGroup]="itemForm" class="item-form">
    <div class="form-grid">
      <div>
        <label for="produtoId">Produto (Estoque): <span class="required">*</span></label>
        <select id="produtoId" formControlName="produtoId" required>
          <option [ngValue]="null" disabled>Selecione um produto</option>
          <option *ngFor="let p of produtos" [value]="p.codproduto">
            {{ p.nomeproduto }} ({{ p.quantidade }})
          </option>
        </select>
      </div>

      <div>
        <label for="quantidade">Quantidade: <span class="required">*</span></label>
        <input type="number" id="quantidade" formControlName="quantidade" min="1" required>
      </div>

      <div>
        <label for="valor">Valor Unit. (R$): <span class="required">*</span></label>
        <input type="number" id="valor" formControlName="valor" min="0" step="0.01" required>
      </div>
    </div>

    <button type="button" (click)="adicionarItem()" class="btn btn-primary">
      <i class="material-icons">add</i>
      Adicionar Item
    </button>
  </div>

  <hr style="margin: 32px 0; border: none; border-top: 1px solid #e2e8f0;">

  <h3>Itens da Venda</h3>
  <table *ngIf="itensVenda.length > 0">
    <thead>
      <tr>
        <th>Produto</th>
        <th>Quantidade</th>
        <th>Valor Unit.</th>
        <th>Subtotal</th>
        <th>Ação</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let item of itensVenda; let i = index">
        <td>{{ item.produto.nomeproduto }}</td>
        <td>{{ item.quantidade }}</td>
        <td>{{ item.valor | currency: 'BRL' }}</td>
        <td>{{ (item.quantidade * item.valor) | currency: 'BRL' }}</td>
        <td>
          <button type="button" (click)="removerItem(i)" class="btn btn-delete">
            <i class="material-icons">delete</i>
            Remover
          </button>
        </td>
      </tr>
    </tbody>
  </table>

  <div *ngIf="itensVenda.length === 0" class="empty-state" style="padding: 40px 20px;">
    <i class="material-icons">shopping_cart</i>
    <p>Nenhum produto adicionado ainda</p>
  </div>

  <div class="total-container" *ngIf="itensVenda.length > 0">
    <strong>Total: {{ calcularTotalVenda() | currency: 'BRL' }}</strong>
  </div>

  <div class="form-actions">
    <button type="submit" class="btn btn-primary">
      <i class="material-icons">save</i>
      {{ isEdit ? 'Atualizar' : 'Salvar' }} Venda
    </button>
    <a routerLink="/vendas" class="btn btn-cancel">
      <i class="material-icons">close</i>
      Cancelar
    </a>
  </div>
</form>